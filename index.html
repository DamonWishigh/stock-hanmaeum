<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hanmaeum Stock System</title>
    <style>
        :root { --primary: #1976d2; --accent: #2e7d32; --danger: #d32f2f; --bg: #f5f7fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        
        /* Header & Control Panel */
        .header { background: var(--primary); color: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        label { font-size: 0.9rem; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        select, input[type="text"] { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; box-sizing: border-box; }
        
        /* Item Management */
        .add-item-box { background: #e8f5e9; border: 2px dashed var(--accent); }
        .btn-add { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; margin-top: 8px; width: 100%; }

        /* Stock Cards */
        .stock-card { position: relative; border-left: 6px solid var(--primary); }
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .item-name { font-size: 1.1rem; font-weight: bold; }
        .btn-remove { color: var(--danger); font-size: 0.8rem; border: 1px solid var(--danger); padding: 2px 8px; border-radius: 4px; text-decoration: none; }
        
        .starting-qty { font-size: 0.85rem; color: #666; margin-bottom: 10px; display: block; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .input-group label { font-size: 0.75rem; text-align: center; color: #777; margin-bottom: 3px; }
        input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; text-align: center; font-size: 1.1rem; -webkit-appearance: none; }
        
        /* Modal Summary */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); overflow-y: auto; }
        .modal-content { background: white; margin: 10px auto; padding: 20px; width: 90%; border-radius: 15px; box-sizing: border-box; }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        .summary-table th, .summary-table td { border: 1px solid #eee; padding: 8px; text-align: center; }
        .summary-table th { background: #f8f9fa; }

        /* Buttons */
        .btn-main { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; margin: 20px 0; box-shadow: 0 4px 10px rgba(25, 118, 210, 0.3); }
        .confirm-btns { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top: 20px; }
        .btn-back { background: #9e9e9e; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; }
        .btn-go { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; }

        .loading-overlay { display: none; text-align: center; padding: 20px; color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0;">üì¶ Hanmaeum Stock</h2>
    <p style="margin:5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p>
</div>

<div class="card">
    <label>üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ:</label>
    <select id="monthYear" onchange="fetchInitialData()">
        <option value="January 2026">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2026</option>
        <option value="February 2026">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2026</option>
        <option value="March 2026">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏° 2026</option>
        </select>

    <label style="margin-top:10px;">üìÜ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
    <select id="selectedDate" onchange="fetchInitialData()"></select>
</div>

<div class="card add-item-box">
    <label>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
    <input type="text" id="newItemName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô Excel">
    <button class="btn-add" onclick="addNewItem()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ</button>
</div>

<div id="loading" class="loading-overlay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤...</div>
<div id="item-list"></div>

<button class="btn-main" onclick="showSummary()">üíæ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

<div id="summaryModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-top:0; color:var(--primary);">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ô‡∏±‡∏ö</h2>
        <div id="summaryBody"></div>
        <div class="confirm-btns">
            <button class="btn-back" onclick="closeModal()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn-go" id="confirmBtn" onclick="submitData()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>
        </div>
    </div>
</div>

<script>
    // ‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwn__dGraDB5MFJ-HgvaLcaZNiEbdgsyGhm1ddIZzzc-pRUo8lepiV9ATLw69k_oICpzQ/exec';

    let items = [
    "‡∏ô‡πâ‡∏≥", "‡πÇ‡∏ã‡∏î‡∏≤", "‡πÇ‡∏Ñ‡πâ‡∏Å", "‡πÇ‡∏Ñ‡πâ‡∏Å‡∏ã‡∏µ‡πÇ‡∏£‡πà", "‡πÅ‡∏ü‡∏ô‡∏ï‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°", "‡πÅ‡∏ü‡∏ô‡∏ï‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏≠‡∏á‡∏∏‡πà‡∏ô", 
    "‡∏™‡πÑ‡∏õ‡∏£‡∏ó‡πå", "‡∏™‡πÑ‡∏õ‡∏£‡∏ó‡πå‡∏ã‡∏µ‡πÇ‡∏£‡πà", "‡∏à‡∏¥‡∏ô‡πÇ‡∏£‡πà‡∏≠‡∏µ‡∏™‡πÅ‡∏ö‡∏•‡πá‡∏Ñ", "‡πÇ‡∏ã‡∏à‡∏π‡∏ä‡∏≤‡∏°‡∏¥‡∏ã‡∏¥‡∏•‡πÄ‡∏ü‡∏£‡∏ä", 
    "‡πÇ‡∏ã‡∏à‡∏π ‡∏≠‡∏µ‡∏ã‡∏¥‡∏• ‡∏Å‡∏£‡∏µ‡∏ô‡πÄ‡∏Å‡∏£‡∏õ", "‡πÇ‡∏ã‡∏à‡∏π ‡∏≠‡∏µ‡∏ã‡∏¥‡∏• ‡∏û‡∏µ‡∏ä", "‡πÇ‡∏ã‡∏à‡∏π ‡∏≠‡∏µ‡∏ã‡∏¥‡∏• ‡πÄ‡∏•‡∏°‡πà‡∏≠‡∏ô", 
    "‡πÇ‡∏ã‡∏à‡∏π ‡∏≠‡∏µ‡∏ã‡∏¥‡∏• ‡∏™‡∏ï‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà", "‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏ó‡∏≠‡∏£‡πà‡∏≤", "‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏¥‡∏á‡∏´‡πå", "‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πâ‡∏≤‡∏á", 
    "Meridian", "‡∏°‡∏±‡∏Ñ‡∏Å‡∏≠‡∏•‡∏•‡∏µ ‡∏ß‡∏≠‡∏•‡πÅ‡∏° ‡∏≠‡∏≠‡∏£‡∏¥‡∏à‡∏¥‡∏ô‡∏±‡∏•", "‡∏°‡∏±‡∏Ñ‡∏Å‡∏≠‡∏•‡∏•‡∏µ ‡∏Å‡∏£‡∏µ‡∏ô‡πÄ‡∏Å‡∏£‡∏õ", 
    "‡∏≠‡∏¥‡∏°‡∏û‡∏∏‡∏•‡∏ä‡∏¥‡∏ô‡πÇ‡∏£ ‡πÇ‡∏ã‡∏à‡∏π", "‡πÇ‡∏Å‡∏•‡πÄ‡∏î‡πâ‡∏ô‡∏ö‡∏•‡∏π", "‡∏£‡∏µ‡πÄ‡∏à‡∏ô‡∏ã‡∏µ‡πà"
     ];

    let initialStocks = {};

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-31
    const dateSel = document.getElementById('selectedDate');
    for (let i = 1; i <= 31; i++) {
        let opt = document.createElement('option');
        opt.value = i; opt.text = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà " + i;
        if (i === new Date().getDate()) opt.selected = true;
        dateSel.appendChild(opt);
    }

    async function fetchInitialData() {
        const date = document.getElementById('selectedDate').value;
        const month = document.getElementById('monthYear').value;
        const loading = document.getElementById('loading');
        const container = document.getElementById('item-list');
        
        loading.style.display = 'block';
        container.style.opacity = '0.3';

        try {
            const res = await fetch(`${scriptURL}?date=${date}&monthYear=${month}`);
            initialStocks = await res.json();
            const draft = JSON.parse(localStorage.getItem(`draft_${month}_${date}`)) || {};
            renderItems(initialStocks, draft);
        } catch (e) { 
            console.error(e);
            renderItems({}, {}); 
        } finally {
            loading.style.display = 'none';
            container.style.opacity = '1';
        }
    }

    function renderItems(starts, drafts) {
        const container = document.getElementById('item-list');
        container.innerHTML = '';
        items.forEach((item, i) => {
            const d = drafts[item] || { add: 0, waste: 0, used: 0 };
            container.innerHTML += `
                <div class="card stock-card">
                    <div class="item-header">
                        <div class="item-name">${item}</div>
                        <a href="#" class="btn-remove" onclick="removeItem(${i})">‡∏•‡∏ö</a>
                    </div>
                    <span class="starting-qty">‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤: <b>${starts[item] || 0}</b></span>
                    <div class="input-grid">
                        <div class="input-group"><label>‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°</label><input type="number" id="add_${i}" value="${d.add}" oninput="saveDraft()"></div>
                        <div class="input-group"><label style="color:var(--danger)">‡πÄ‡∏™‡∏µ‡∏¢</label><input type="number" id="waste_${i}" value="${d.waste}" oninput="saveDraft()"></div>
                        <div class="input-group"><label>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</label><input type="number" id="used_${i}" value="${d.used}" oninput="saveDraft()"></div>
                    </div>
                </div>`;
        });
    }

    function addNewItem() {
        const name = document.getElementById('newItemName').value.trim();
        if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
        if (items.includes(name)) return alert("‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
        items.push(name);
        localStorage.setItem('hanmaeum_items', JSON.stringify(items));
        document.getElementById('newItemName').value = "";
        fetchInitialData();
    }

    function removeItem(index) {
        if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏≠‡∏õ?")) {
            items.splice(index, 1);
            localStorage.setItem('hanmaeum_items', JSON.stringify(items));
            fetchInitialData();
        }
    }

    function saveDraft() {
        const date = document.getElementById('selectedDate').value;
        const month = document.getElementById('monthYear').value;
        let draftData = {};
        items.forEach((item, i) => {
            draftData[item] = { 
                add: document.getElementById(`add_${i}`).value || 0, 
                waste: document.getElementById(`waste_${i}`).value || 0, 
                used: document.getElementById(`used_${i}`).value || 0 
            };
        });
        localStorage.setItem(`draft_${month}_${date}`, JSON.stringify(draftData));
    }

    function showSummary() {
        const date = document.getElementById('selectedDate').value;
        const month = document.getElementById('monthYear').value;
        let html = `<p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${date} ${month}</p>`;
        html += `<table class="summary-table">
                    <thead><tr><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏¢‡∏Å‡∏°‡∏≤</th><th>‡∏£‡∏±‡∏ö</th><th>‡πÄ‡∏™‡∏µ‡∏¢</th><th>‡πÉ‡∏ä‡πâ</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr></thead><tbody>`;
        
        let hasData = false;
        items.forEach((item, i) => {
            const s = parseInt(initialStocks[item] || 0);
            const a = parseInt(document.getElementById(`add_${i}`).value || 0);
            const w = parseInt(document.getElementById(`waste_${i}`).value || 0);
            const u = parseInt(document.getElementById(`used_${i}`).value || 0);
            const bal = s + a - w - u;
            
            if (a !== 0 || w !== 0 || u !== 0) {
                hasData = true;
                html += `<tr>
                    <td style="text-align:left">${item}</td>
                    <td>${s}</td>
                    <td style="color:blue">${a}</td>
                    <td style="color:red">${w}</td>
                    <td>${u}</td>
                    <td style="background:#fff9c4"><b>${bal}</b></td>
                </tr>`;
            }
        });

        if(!hasData) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");

        document.getElementById('summaryBody').innerHTML = html + `</tbody></table>`;
        document.getElementById('summaryModal').style.display = 'block';
    }

    function closeModal() { document.getElementById('summaryModal').style.display = 'none'; }

    async function submitData() {
        const btn = document.getElementById('confirmBtn');
        btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        
        const date = document.getElementById('selectedDate').value;
        const month = document.getElementById('monthYear').value;
        let payload = { selectedDate: date, monthYear: month, items: [] };

        items.forEach((item, i) => {
            payload.items.push({
                name: item,
                add: document.getElementById(`add_${i}`).value || 0,
                waste: document.getElementById(`waste_${i}`).value || 0,
                used: document.getElementById(`used_${i}`).value || 0
            });
        });

        try {
            const response = await fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload) });
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‚úÖ");
            closeModal();
        } catch (e) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            console.error(e);
        } finally {
            btn.disabled = false; btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ";
        }
    }

    window.onload = fetchInitialData;
</script>
</body>
</html>
